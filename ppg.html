<html>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<link rel="apple-touch-icon-precomposed" href="apple-touch-icon-precomposed.png" />
  
  

<script type='text/javascript' src='https://cdn.firebase.com/v0/firebase.js'></script>
<script src="fireball.js"></script>
<script src="http://connect.soundcloud.com/sdk.js"></script>
<link rel="stylesheet" type="text/css" href="ppg.css">
<script>
var page = "home";
var F = new Firebase("https://songwalks.firebaseio.com/");
// always-hot/better-d
</script>

<body>

<select id="browser">
   <option id="count_string"></option>
   <optgroup id="experiences">
      <option data-set="text:calctitle"></option>
   <optgroup>
   <option>New experience!</option>
</select>

<div id="experience" style="position:relative">
   <a id="geolocate" data-set="text:googlemap">(map here)</a>
   <div id="about">
      This experience starts at <form id="placename"><input name="name" data-set="value:placename"></form>
      and is for the song
      <b data-set="text:song_title"></b>
      <select id="choose_song">
         <option>Choose...</option>
         <optgroup id="songs">
            <option data-set="text:#songs:song_title value:#songs:id"></option>
         </optgroup>
         <option>Add...</option>
      </select>
      <a href="#" id="save">SAVE</a> <a href="#" id="edit">EDIT</a>
   </div>

   <img data-set="src:waveform_url" style="-webkit-transform: rotate(90deg); position: absolute; display:block">
</div>


<div id="timeline">
   <div id="playhead">
      <a style="float:right" id="rewind" href="#">REW</a>
      <a id="play" href="#">PLAY/PAUSE</a>
   </div>
   <div id="actions">
      <a data-set="style:style text:text" style="top: 159px" class="action">
         Blow bubbles
      </a>
   </div>
</div>

<!--

//HTML
//* 3 experiences in NYC... Selector (+add closer neighborhood)
//* loads soundcloud waveform rot90 from waveform_img

-->

<div id="add_action">
      <button>+ Dance move</button>
      <button>+ Fitness activity</button>
      <button>+ Thought/feeling</button>
      <button>+ Interaction with person</button>
      <button>+ Interaction with object</button>
</div>
      
<script>
var current_sound, show_browse;

Fireball(F, {
   map:{
      '#experiences' : '/experiences_in_city/$city[]',
      '#experience'  : '/experiences_in_city/$city/$experience',
      '#actions'     : '/p2/actions/$experience[]',
      '#songs'       : '/songs[]'
   },
   
   init:function(){
      console.log('initted');
      SC.initialize({client_id: "43963acff2ef28ec55f039eddcea8478"});
      console.log('soundcloud initialized');
      
      F.dynamic('/experiences_in_city/$city').on('value', function(snap){
         var v = snap.val();
         document.getElementById("count_string").innerHTML = Object.keys(v).length + " experiences nearby in NYC";
      });
      
      // put this inside geocoder
      (function(){
         Fireball.set('$city', '-J8g_WwoZ8WuOxKYfLaY');
      })();
   },
   
   on_change:{

	   '#browser': function(sel){
	      var opt = sel.options[sel.selectedIndex];
	      if (sel.value.match(/^New/)){
	         setTimeout(function(){
      	      var title = prompt('Title:');
   	         if (!title) return;
               var id = Fireball('#experiences').push({title:title}).name();
               Fireball.set('$experience', id);
               current_sound = null;
	         }, 0);
	      } else if (opt.id) {
            Fireball.set('$experience', opt.id);
            current_sound = null;
	      }
	   },

      '#choose_song': function(el){
         var opt = el.options[el.selectedIndex];
         if (el.value.match(/^Add/)){
            setTimeout(function(){
               var url = prompt("Soundcloud URL:");

            if (!url) return el.selectedIndex = 0;
            SC.get('/resolve', {url:url}, function(track){
               // alert('got:' + JSON.stringify(track));
               if (!track) return alert('Sorry, couldn\'t load');
               var properties = {
                  soundcloud_url: "/tracks/" + track.id,
                  soundcloud_id: track.id,
                  waveform_url: track.waveform_url,
                  song_title: track.title
               };
               properties.song_id = Fireball('#songs').push(properties).name();
               Fireball('#experience').update(properties);
            });


            }, 0);
         } else {
            Fireball('#experience').update(opt.data);
         }
      }
   },
   
   calculated_fields:{
      "#experience googlemap": function(exp){
         if (!exp.start_loc) return "<a href='#' id='geolocate'>Geolocate!</a>";
         var mapUrl = "http://maps.google.com/maps/api/staticmap?markers=";
         mapUrl = mapUrl + exp.start_loc[0] + ',' + exp.start_loc[1];
         mapUrl = mapUrl + '&zoom=16&size=320x100&maptype=roadmap&sensor=true&key=AIzaSyA51bUQ2qrcA4OqxkBVktwFkxH9XEqcG3A';
         return "<img src='"+mapUrl+"'>";
      },
      
      "#experiences calctitle": function(exp){
         // TODO: make from start loc name and song name and authors
         return exp.song_title + " @ " + exp.placename;
      },
      
      '#actions style': function(action){
         return "top: " + (action.t * 4 + 20) + "px";
      }
   },
   
   show_when:{
      '#experience': function(){ return Fireball.get('$experience'); },
      '#timeline':   function(){ return Fireball.get('$experience'); },
      '#add_action, #save, #choose_song': function(){
         var latest = Fireball.latest('#experience');
         return latest && !latest.saved; 
      },
      '#edit': function(){
         return Fireball.get('$experience') && Fireball.latest('#experience').saved; 
      }
   },

	on_click: {
	   '.action': function(el){
	      alert('you clicked ' + el.id);
	   },
	
	   '#add_action button': function(el){
         var new_action = prompt('What:');
         if (new_action) Fireball('#actions').push({
            t: current_sound.position / 1000,
            type: el.innerText,
            text: new_action
         });
      },
    
      '#cities a': function(el){
         Fireball.set('$city', el.id);
      },
      
	   '#new_city': function(){
	      var name = prompt('City:');
	      if (name) Fireball('#cities').push({name:name});
	   },
		   
	   '#geolocate':function(){
   	      navigator.geolocation.getCurrentPosition(function(pos){
   	         Fireball('#experience').update({ 'start_loc': [
   	            pos.coords.latitude, pos.coords.longitude
   	         ] });
   	      });
	   },
	   
      "#rewind": function(){
         current_sound.setPosition(0);
      },
      "#save":function(){
         Fireball('#experience').update({ saved: true });
      },
      "#edit":function(){
         Fireball('#experience').update({ saved: false });
      },
      "#play": function(){
         if (current_sound) return current_sound.togglePause();

         // configure soundcloud using Latest
         var exp = Fireball.latest('#experience');
         SC.stream(exp.soundcloud_url, function(sound){
            current_sound = sound;
            sound.play({
               'whileplaying': function(){
                  var px = sound.position / 250;
                  document.getElementById('playhead').style.top = px + "px";
               }
            });
         });
      }
	},
	
	on_submit:{
      '#placename': function(form){
         Fireball('#experience').update({ 'placename': form.name.value });
      }
	}
});

</script>
