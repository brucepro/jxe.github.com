<meta name="viewport" content="width=device-width, user-scalable=false;">
<script src="zepto.min.js"></script>
<script type='text/javascript' src='https://cdn.firebase.com/v0/firebase.js'></script>

<!--

## TODO
- remove old instructions in configure functions..

LATER
- paused mode should seek
- drag should go to paused 0
- add photo taking


## SCHEMA

// changes slowly, as roles are declared and recorded
roles: [{
	title: "",
	recorded_at: 0,
	taken_at: 0,
	walk: "",
	city: ""
}]

// changes quick as events added and playstate changes
walks: {
	id: {
		song: "rooster",
		is: "playing/paused",
		events: [[t, ev], [t, ev]],
		roles: []
	}
}

-->

<div id="home">
	<h2>Home</h2>
	<ul id="menu">
		<div id="recordables"></div>
		<div id="playables"></div>	
		<li><a href="javascript:new_songwalk()">new songwalk</a>
	</ul>
</div>

<div id="device" style="display:none">
	<audio controls="yeah"></audio>
	<p id="instructions"></p>
	<div id="annotation_controls">
		<a href="javascript:add_instructions()">add instructions</a>
		<!-- <a href="#">add image</a> -->
	</div>
	<a href="javascript:back()">back</a>
</div>


<script type="text/javascript">

var F = new Firebase("https://songwalks.firebaseio.com/");
var uid = F.push().name();
var audio = document.querySelector('audio');
var instructions = audio.addTextTrack('descriptions');

var FULL_TITLES = {
	rooster: "Dina Maccabees's \"The Rooster\""
};

function now(){ return (new Date()).getTime(); };

var current_role_name;
var current_walk;

F.child('roles').on('value', function(v){
	// list all available roles in #recordables
	$('#recordables').empty();
	$('#playables').empty();
	v.forEach(function(r){
		var role = r.val();
		if (!role.recorded_at){
			var title = "record " + role.title;
			var link = $('<li><a href="#">' + title + '</a></li>');
			link.appendTo('#recordables').on('click', function(){
				r.ref().child('recorded_at').set(now());
				current_role_name = r.name();
				attach_device_to_walk(F.child('walks').child(role.walk));
				configure_as_recorder();
				return false;
			});
		} else if (!role.taken_at || five_minutes_ago(role.taken_at)) {
			var title = "play " + role.title;
			var link = $('<li><a href="#">' + title + '</a></li>');
			link.appendTo('#playables').on('click', function(){
				r.ref().child('taken_at').set(now());
				current_role_name = r.name();
				attach_device_to_walk(F.child('walks').child(role.walk));
				configure_as_player();
				return false;
			});			
		}
	});
});


function configure_as_recorder(){
	$('#annotation_controls').show();
}

function configure_as_player(){
	$('#annotation_controls').hide();
	current_walk.child('is').set('paused:0');
	current_walk.child('events').once('value', function(v){
		v.forEach(function(ev){
			var e = ev.val();
			if (e.role == current_role_name){
				instructions.addCue(new TextTrackCue(e.t, e.t+3, e.text));
			}
		});
	});

	instructions.oncuechange = function (){
	  var cue = this.activeCues[0]; // assuming there is only one active cue
	  if (cue && cue.text){
	  	$('#instructions').html(cue.text);
	  	beep();
	  }
	};
}

function add_instructions(){
	var audio = document.querySelector('audio');
	var text = prompt('What instructions?');
	if (!text) return;
	current_walk.child('events').push({
		role: current_role_name,
		t: audio.currentTime,
		text: text
	});
}




audio.addEventListener('play', function(){
	if (current_walk) current_walk.child('is').set('playing');
})
audio.addEventListener('pause', function(){
	if (current_walk) current_walk.child('is').set('paused');
})
audio.addEventListener('ended', detach_device);

function five_minutes_ago(t){
	return now() - t > 20*1000;
}

function back(){ detach_device(); }


function detach_device(){
	if (!current_walk) return;
	audio.pause();
	current_walk.child('song').off();
	current_walk.child('is').off();
	current_walk = null;
	$('#device').hide();
	$('#home').show();
	var cues = instructions.cues;
	for (var i = 0; i < cues.length; i++) {
		instructions.removeCue(cues[i]);
	};
	$('#instructions').empty();
}

function attach_device_to_walk(walk){
	detach_device();
	current_walk = walk;
	walk.child('song').on('value', function(s){
		audio.src = s.val() + ".mp3";
	});
	walk.child('is').on('value', function(s){
		var state = s.val() || 'paused:0';
		if (state == "playing") audio.play();
		else {
			audio.pause();
			if (state == "paused:0") {
				audio.currentTime = 0;
			}
		}
	});
	$('#home').hide();
	$('#device').show();
}

function new_songwalk(){
	// in walks: set song and roles[]
	// in roles: set title, walk, city
	var song = prompt('Song:');
	if (!song) return;
	var location = prompt('Location:');
	if (!location) return;
	var role_count = Number(prompt('How many players?'));
	if (!role_count) return;
	var role_ids = [];
	var title = FULL_TITLES[song] + " for " + role_count + " players, at " + location;
	var walk = F.child('walks').push({
		title: title,
		song: song,
		city: "lax"
	});
	for (var i = 0; i < role_count; i++) {
		var role = F.child('roles').push({
			walk: walk.name(),
			city: 'lax',
			title: "Player " + (i+1) + " for " + FULL_TITLES[song] + " at " + location
		})
		walk.child('roles').push(role.name());
	};
}




var beep = (function () {
    var ctx = new(window.audioContext || window.webkitAudioContext);
    return function (duration, type, finishedCallback) {
        duration = +duration;
        type = (type % 5) || 0;  // Only 0-4 are valid types.
        if (typeof finishedCallback != "function") {
            finishedCallback = function () {};
        }
        var osc = ctx.createOscillator();
        osc.type = type;
        osc.connect(ctx.destination);
        osc.noteOn(0);
        setTimeout(function () {
            osc.noteOff(0);
            finishedCallback();
        }, duration);
    };
})();








// var engine = {
// 	current_script: null,
// 	current_role: null,
// 	scripts: {},

// 	script: function (song, obj, cb) {
// 		obj.song = song;
// 		obj.roles = {};
// 		engine.current_script = obj;
// 		engine.scripts[song] = obj;
// 		cb(engine);
// 	},

// 	role: function(name, count, cb){
// 		engine.current_role = {
// 			name: name,
// 			count: count,
// 			moves: []
// 		};
// 		engine.current_script.roles[name] = engine.current_role;
// 		cb(engine);
// 	},

// 	move: function(time, alert){
// 		engine.current_role.moves.push({
// 			t: time,
// 			alert: alert
// 		});
// 	},

// 	play: function(song, role){
// 		var audio = document.querySelector('audio');
// 		audio.src = song + ".mp3";
// 		var dance = engine.scripts[song];
// 		var track = audio.addTextTrack('descriptions');
// 		var moves = dance.roles[role].moves;
// 		for (var i = moves.length - 1; i >= 0; i--) {
// 			var move = moves[i];
// 			track.addCue(new TextTrackCue(move.t, move.t+3, move.alert));
// 		};

// 		track.oncuechange = function (){
// 		  var cue = this.activeCues[0]; // assuming there is only one active cue
// 		  console.log(cue && cue.text);
// 		  if (cue) alert(cue.text);
// 		};

// 		// audio.play();
// 	}
// };

// engine.script('rooster', {
// 	latlng: [37.811729, -122.269964],
// 	city: "Oakland, CA",
// 	neighborhood: "Downtown",
// 	title: "Oakland Rooster",
// 	count: 1,
// }, function(_){
// 	_.role("Orsino", 1, function(){

// 		_.move(3, "Wonder about life.");
// 		_.move(30, "Duck down like a duck ducking down.");
// 		_.move(45, "Touch your heart.");
// 		_.move(60, "Lie on your back for the rest of the song.");

// 	});
// });

// engine.play('rooster', "Orsino");

</script>





